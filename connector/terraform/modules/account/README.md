# `elastio-connector-account` module

Deploys an AWS CloudFormation stack named `elastio-account-level-stack`, which is deployed once per AWS account and contains the required IAM resources (roles, policies, etc.) for Elastio Connector to operate in the same account.

See the [`elastio-connector` module implementation](../../main.tf) for an example of how this module should be used.

## Installation

[Configure](../../README.md#configuring-the-terraform-modules-registry) the Elastio terraform module registry, and add this to your project:

```tf
module "elastio_connector_account" {
  source  = "terraform.cloudsmith.io/public/elastio-conenctor-account/aws"
  version = "0.33.1"

  // Provide input parameters
}
```

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version |
| ------------------------------------------------------------------------ | ------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | ~> 1.0  |
| <a name="requirement_aws"></a> [aws](#requirement_aws)                   | ~> 5.0  |
| <a name="requirement_http"></a> [http](#requirement_http)                | ~> 3.0  |

## Providers

| Name                                                               | Version |
| ------------------------------------------------------------------ | ------- |
| <a name="provider_aws"></a> [aws](#provider_aws)                   | ~> 5.0  |
| <a name="provider_http"></a> [http](#provider_http)                | ~> 3.0  |
| <a name="provider_terraform"></a> [terraform](#provider_terraform) | n/a     |

## Modules

No modules.

## Resources

| Name                                                                                                                              | Type        |
| --------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [aws_cloudformation_stack.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudformation_stack) | resource    |
| [terraform_data.service_linked_roles](https://registry.terraform.io/providers/hashicorp/terraform/latest/docs/resources/data)     | resource    |
| [http_http.cloudformation_template](https://registry.terraform.io/providers/hashicorp/http/latest/docs/data-sources/http)         | data source |

## Inputs

| Name                                                                                                                                             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Type                                                                                                                                                                                                                                                                                                                                                                           | Default    | Required |
| ------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------- | :------: |
| <a name="input_disable_customer_managed_iam_policies"></a> [disable_customer_managed_iam_policies](#input_disable_customer_managed_iam_policies) | If this is set to `false` (or omitted), then the stack will create<br/> additional customer-managed IAM policies that you can attach to your<br/> IAM identities to grant them direct access to the Elastio Connector stack.<br/> This way you can use elastio CLI directly to list Elastio scan jobs or<br/> submit new scan jobs. Set this to `true` if you don't need these policies.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `bool`                                                                                                                                                                                                                                                                                                                                                                         | `null`     |    no    |
| <a name="input_ecr_public_prefix"></a> [ecr_public_prefix](#input_ecr_public_prefix)                                                             | Repository prefix for the ECR Public registry. Used to configure a pull-through<br/> cache for elastio images that are downloaded from ECR Public. You can configure<br/> your own cache via ECR private, and then specify the repository prefix here.<br/><br/> This field supports 'account_id' and 'region' interpolation.<br/> For example, such value can be provided:<br/> '{{account\_id}}.dkr.ecr.{{region}}.amazonaws.com/ecr-public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_elastio_pat"></a> [elastio_pat](#input_elastio_pat)                                                                               | Personal Access Token generated by the Elastio Portal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                       | n/a        |   yes    |
| <a name="input_elastio_tenant"></a> [elastio_tenant](#input_elastio_tenant)                                                                      | Name of your Elastio tenant. For example `mycompany.app.elastio.com`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                       | n/a        |   yes    |
| <a name="input_encrypt_with_cmk"></a> [encrypt_with_cmk](#input_encrypt_with_cmk)                                                                | Provision additional customer-managed KMS keys to encrypt<br/> Lambda environment variables, DynamoDB tables, S3. Note that<br/> by default data is encrypted with AWS-managed keys.<br/><br/> Enable this option only if your compliance requirements mandate the usage of CMKs.<br/><br/> If this option is disabled Elastio creates only 1 CMK per region where<br/> the Elastio Connector stack is deployed. If this option is enabled then<br/> Elastio creates 1 KMS key per AWS account and 2 KMS keys per every AWS<br/> region where Elastio is deployed in your AWS account.<br/><br/> If you have `elastio_nat_provision_stack` enabled as well, then 1 more KMS key<br/> will be created as part of that stack as well (for a total of 3 KMS keys per region).                                                                                                                                                                                                                                                                                                                                                                                | `bool`                                                                                                                                                                                                                                                                                                                                                                         | `null`     |    no    |
| <a name="input_global_managed_policies"></a> [global_managed_policies](#input_global_managed_policies)                                           | List of IAM managed policies ARNs to attach to all Elastio IAM roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `set(string)`                                                                                                                                                                                                                                                                                                                                                                  | `null`     |    no    |
| <a name="input_global_permission_boundary"></a> [global_permission_boundary](#input_global_permission_boundary)                                  | The ARN of the IAM managed policy to use as a permission boundary for all Elastio IAM roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_iam_resource_names_prefix"></a> [iam_resource_names_prefix](#input_iam_resource_names_prefix)                                     | Add a custom prefix to names of all IAM resources deployed by this stack.<br/> The sum of the length of the prefix and suffix must not exceed 14 characters.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_iam_resource_names_static"></a> [iam_resource_names_static](#input_iam_resource_names_static)                                     | If enabled, the stack will use static resource names without random characters in them.<br/><br/> This parameter is set to `true` by default, and it shouldn't be changed. The older<br/> versions of Elastio stack used random names generated by CloudFormation for IAM<br/> resources, which is inconvenient to work with. New deployments that use the terraform<br/> automation should have this set to `true` for easier management of IAM resources.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `bool`                                                                                                                                                                                                                                                                                                                                                                         | `true`     |    no    |
| <a name="input_iam_resource_names_suffix"></a> [iam_resource_names_suffix](#input_iam_resource_names_suffix)                                     | Add a custom prefix to names of all IAM resources deployed by this stack.<br/> The sum of the length of the prefix and suffix must not exceed 14 characters.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_lambda_tracing"></a> [lambda_tracing](#input_lambda_tracing)                                                                      | Enable AWS X-Ray tracing for Lambda functions. This increases the cost of<br/> the stack. Enable only if needed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `bool`                                                                                                                                                                                                                                                                                                                                                                         | `null`     |    no    |
| <a name="input_network_configuration"></a> [network_configuration](#input_network_configuration)                                                 | Can be set to either `Auto` or `Manual`. If set to `Auto`, Elastio will<br/> automatically create a VPC and subnets in the specified regions for the<br/> scan clusters to run in.<br/><br/> If set to `Manual`, you must provide the `vpc_id` and `subnet_ids` in the<br/> `region` module with the network config for each region.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                       | `"Manual"` |    no    |
| <a name="input_regional_configs"></a> [regional_configs](#input_regional_configs)                                                                | Regional configurations for connectors (mostly for regulatory compliance).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <pre>list(object({<br/> region = string<br/><br/> s3_access_logging = optional(object({<br/> target_bucket = string<br/> target_prefix = optional(string)<br/><br/> # Can be one of the following:<br/> # - SimplePrefix<br/> # - PartitionedPrefix:EventTime<br/> # - PartitionedPrefix:DeliveryTime<br/> target_object_key_format = optional(string)<br/> }))<br/> }))</pre> | `[]`       |    no    |
| <a name="input_service_linked_roles"></a> [service_linked_roles](#input_service_linked_roles)                                                    | By default the CFN stack creates the service-linked IAM roles needed by the stack.<br/> Since these are global in your account, they can't be defined as regular resources<br/> in the CFN, because these roles may already exist in your account and thus<br/> the deployment would fail on a name conflict.<br/><br/> Instead, by default, they are deployed using an AWS::CloudFormation::CustomResource<br/> which invokes an AWS Lambda function that creates the service-linked roles only if<br/> they don't exist and doesn't fail if they do.<br/><br/> The default approach of creating the service-linked roles via the CFN requires<br/> creating a lambda function in your environment that has IAM write permission of<br/> `iam:CreateServiceLinkedRole`. If you can't afford creating such a lambda function<br/> then set this parameter to `tf` and this terraform module will create the<br/> service-linked roles without the need for a lambda function.<br/><br/> If you set this to `tf`, then make sure you have the AWS CLI installed and<br/> configured with the necessary credentials on the machine where you run terraform. | `string`                                                                                                                                                                                                                                                                                                                                                                       | `"cfn"`    |    no    |

## Outputs

| Name                                                                                            | Description                                                                                                                                          |
| ----------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| <a name="output_cloudformation_stack"></a> [cloudformation_stack](#output_cloudformation_stack) | The deployed CloudFormation stack may be used as an input for other stacks<br/> like the `nat-provision` stack to let it inherit the configurations. |

<!-- END_TF_DOCS -->
