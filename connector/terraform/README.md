# Elastio Connector Terraform Deployment

This directory contains terraform modules that you may use to automate the deployment of the Elastio Connector stacks in your AWS accounts.

## Obtain a Personal Access Token (PAT)

First of all, you'll need a secret PAT token to authenticate your Elastio installation with the Elastio Portal. You can generate one by following the steps below.

1. Open the [Elastio Portal](https://login.elastio.com/) in your web browser.
2. Go to the `Settings` page.
3. Open the `API access` tab.
4. Click on `Add New Access Token`.
5. Enter the name for the token, for example `Elastio deployment`.
6. Select the scope `Sources: Write` for the token.
7. Click on `Generate Token`.
8. Copy the generated token.
9. _Optional step._ Save the token in a secure place like 1Password or any other secret management system of your choice. This way you won't lose it.

## Add Elastio to Your Terraform

There is are several terraform modules that you can use. We'll review all of them below.

## Installation

[Configure](../../README.md#configuring-the-terraform-modules-registry) the Elastio terraform module registry before adding any Elastio terraform modules to your project.

### `elastio-connector` module

This module provides the easiest way to get started. It resides as the top-level module in this directory. It deploys all the necessary resources for Elastio to operate in a single module for the entire AWS account and covers many regions.

Add this terraform module to your terraform project and specify the necessary input variables. Here you'll need to pass the PAT token you [generated earlier](#obtain-a-personal-access-token-pat).

> [!IMPORTANT]
> Make sure `curl` of version _at least_ `7.76.0` is installed on the machine that runs the terraform deployment (`terraform apply`). The provided terraform module uses a `local-exec` provisioner that uses `curl` to do a REST API call to Elastio Portal.

Here is the basic example usage of the module that deploys Elastio Connectors in several regions allowing you to scan your assets in these regions.

```tf
module "elastio_connector" {
  source  = "terraform.cloudsmith.io/public/elastio-connector/aws"
  version = "0.33.2"

  elastio_tenant = var.elastio_tenant
  elastio_pat    = var.elastio_pat

  elastio_cloud_connectors = [
    {
      region = "us-east-1"
    },
    {
      region = "us-east-2",
    }
  ]
}
```

You can find the full version of this example in [`examples/basic`](./examples/basic).

This module deploys the following three modules internally, that you can deploy individually if a finer grained control over the deployment is required. You may use them, for example, if you need to deploy regional stacks in separate terraform projects instead of using a single one that deploys all regions.

### `elastio-connector-account` module

Creates an AWS CloudFormation stack named `elastio-account-level-stack`, which is deployed once per AWS account and contains the required IAM resources (roles, policies, etc.) for Elastio Connector to operate in the same account.

See [`modules/account`](./modules/account) directory for details.

### `elastio-connector-region` module

Deploys the Elastio Cloud Connector stack via a REST API call to the Elastio Portal. The final stack contains Lambda functions, DynamoDB databases, S3 buckets, AWS Batch compute environments and other non-IAM resources.

See [`modules/region`](./modules/region) directory for details.

### `elastio-nat-provision` module

_Optional._ AWS CloudFormation stack named `elastio-nat-provision-lambda` which deploys NAT gateways in the private subnets where Elastio scan job workers run. This is necessary only if you deploy Elastio into private subnets that don't have outbound Internet access already. Alternatively, you can deploy your own NAT gateway if you want to.

See [`modules/nat-provision`](./modules/nat-provision) directory for details.

## Documentation for `elastio-connector` module

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version |
| ------------------------------------------------------------------------ | ------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | ~> 1.9  |
| <a name="requirement_aws"></a> [aws](#requirement_aws)                   | ~> 5.0  |
| <a name="requirement_http"></a> [http](#requirement_http)                | ~> 3.0  |

## Providers

No providers.

## Modules

| Name                                                                       | Source                  | Version |
| -------------------------------------------------------------------------- | ----------------------- | ------- |
| <a name="module_account"></a> [account](#module_account)                   | ./modules/account       | n/a     |
| <a name="module_nat_provision"></a> [nat_provision](#module_nat_provision) | ./modules/nat-provision | n/a     |
| <a name="module_region"></a> [region](#module_region)                      | ./modules/region        | n/a     |

## Resources

No resources.

## Inputs

| Name                                                                                                                                             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Default    | Required |
| ------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | :------: |
| <a name="input_disable_customer_managed_iam_policies"></a> [disable_customer_managed_iam_policies](#input_disable_customer_managed_iam_policies) | If this is set to `false` (or omitted), then the stack will create<br/> additional customer-managed IAM policies that you can attach to your<br/> IAM identities to grant them direct access to the Elastio Connector stack.<br/> This way you can use elastio CLI directly to list Elastio scan jobs or<br/> submit new scan jobs. Set this to `true` if you don't need these policies.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`     |    no    |
| <a name="input_ecr_public_prefix"></a> [ecr_public_prefix](#input_ecr_public_prefix)                                                             | Repository prefix for the ECR Public registry. Used to configure a pull-through<br/> cache for elastio images that are downloaded from ECR Public. You can configure<br/> your own cache via ECR private, and then specify the repository prefix here.<br/><br/> This field supports 'account_id' and 'region' interpolation.<br/> For example, such value can be provided:<br/> '{{account\_id}}.dkr.ecr.{{region}}.amazonaws.com/ecr-public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_elastio_cloud_connectors"></a> [elastio_cloud_connectors](#input_elastio_cloud_connectors)                                        | List of regions where Cloud Connectors are to be deployed, VPC and subnet(s) to use,<br/> and other regional configurations (mostly for regulatory compliance).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <pre>list(object({<br/> region = string<br/><br/> # Should not be set if `network_configuration`<br/> # is set to `Auto` (which is the default)<br/> vpc_id = optional(string)<br/> subnet_ids = optional(list(string))<br/><br/> s3_access_logging = optional(object({<br/> target_bucket = string<br/> target_prefix = optional(string)<br/><br/> # Can be one of the following:<br/> # - SimplePrefix<br/> # - PartitionedPrefix:EventTime<br/> # - PartitionedPrefix:DeliveryTime<br/> target_object_key_format = optional(string)<br/> }))<br/> }))</pre> | n/a        |   yes    |
| <a name="input_elastio_nat_provision_stack"></a> [elastio_nat_provision_stack](#input_elastio_nat_provision_stack)                               | Specifies the version of Elastio NAT provision stack to deploy (e.g. `v5`).<br/><br/> This is a CloudFormation stack that automatically provisions NAT Gateways in<br/> your VPC when Elastio worker instances run to provide them with the outbound<br/> Internet access when Elastio is deployed in private subnets.<br/><br/> If you don't need this stack (e.g. you already have NAT gateways in your VPC<br/> or you deploy into public subnets) you can omit this parameter. The default<br/> value of `null` means there won't be any NAT provision stack deployed.<br/><br/> The source code of this stack can be found here:<br/> https://github.com/elastio/contrib/tree/master/elastio-nat-provision-lambda                                                                                                                                                                                                                                                                                                                                                                                                                                    | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_elastio_pat"></a> [elastio_pat](#input_elastio_pat)                                                                               | Personal Access Token generated by the Elastio Portal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a        |   yes    |
| <a name="input_elastio_tenant"></a> [elastio_tenant](#input_elastio_tenant)                                                                      | Name of your Elastio tenant. For example `mycompany.app.elastio.com`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a        |   yes    |
| <a name="input_encrypt_with_cmk"></a> [encrypt_with_cmk](#input_encrypt_with_cmk)                                                                | Provision additional customer-managed KMS keys to encrypt<br/> Lambda environment variables, DynamoDB tables, S3. Note that<br/> by default data is encrypted with AWS-managed keys.<br/><br/> Enable this option only if your compliance requirements mandate the usage of CMKs.<br/><br/> If this option is disabled Elastio creates only 1 CMK per region where<br/> the Elastio Connector stack is deployed. If this option is enabled then<br/> Elastio creates 1 KMS key per AWS account and 2 KMS keys per every AWS<br/> region where Elastio is deployed in your AWS account.<br/><br/> If you have `elastio_nat_provision_stack` enabled as well, then 1 more KMS key<br/> will be created as part of that stack as well (for a total of 3 KMS keys per region).                                                                                                                                                                                                                                                                                                                                                                                | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`     |    no    |
| <a name="input_global_managed_policies"></a> [global_managed_policies](#input_global_managed_policies)                                           | List of IAM managed policies ARNs to attach to all Elastio IAM roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `set(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `null`     |    no    |
| <a name="input_global_permission_boundary"></a> [global_permission_boundary](#input_global_permission_boundary)                                  | The ARN of the IAM managed policy to use as a permission boundary for all Elastio IAM roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_iam_resource_names_prefix"></a> [iam_resource_names_prefix](#input_iam_resource_names_prefix)                                     | Add a custom prefix to names of all IAM resources deployed by this stack.<br/> The sum of the length of the prefix and suffix must not exceed 14 characters.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_iam_resource_names_static"></a> [iam_resource_names_static](#input_iam_resource_names_static)                                     | If enabled, the stack will use static resource names without random characters in them.<br/><br/> This parameter is set to `true` by default, and it shouldn't be changed. The older<br/> versions of Elastio stack used random names generated by CloudFormation for IAM<br/> resources, which is inconvenient to work with. New deployments that use the terraform<br/> automation should have this set to `true` for easier management of IAM resources.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`     |    no    |
| <a name="input_iam_resource_names_suffix"></a> [iam_resource_names_suffix](#input_iam_resource_names_suffix)                                     | Add a custom prefix to names of all IAM resources deployed by this stack.<br/> The sum of the length of the prefix and suffix must not exceed 14 characters.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`     |    no    |
| <a name="input_lambda_tracing"></a> [lambda_tracing](#input_lambda_tracing)                                                                      | Enable AWS X-Ray tracing for Lambda functions. This increases the cost of<br/> the stack. Enable only if needed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`     |    no    |
| <a name="input_network_configuration"></a> [network_configuration](#input_network_configuration)                                                 | Can be set to either `Auto` or `Manual`. If set to `Auto`, Elastio will<br/> automatically create a VPC and subnets in the specified regions for the<br/> scan clusters to run in.<br/><br/> If set to `Manual`, you must provide the VPC ID and subnet IDs in the<br/> `elastio_cloud_connectors` with the network config for each region.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `"Manual"` |    no    |
| <a name="input_service_linked_roles"></a> [service_linked_roles](#input_service_linked_roles)                                                    | By default the CFN stack creates the service-linked IAM roles needed by the stack.<br/> Since these are global in your account, they can't be defined as regular resources<br/> in the CFN, because these roles may already exist in your account and thus<br/> the deployment would fail on a name conflict.<br/><br/> Instead, by default, they are deployed using an AWS::CloudFormation::CustomResource<br/> which invokes an AWS Lambda function that creates the service-linked roles only if<br/> they don't exist and doesn't fail if they do.<br/><br/> The default approach of creating the service-linked roles via the CFN requires<br/> creating a lambda function in your environment that has IAM write permission of<br/> `iam:CreateServiceLinkedRole`. If you can't afford creating such a lambda function<br/> then set this parameter to `tf` and this terraform module will create the<br/> service-linked roles without the need for a lambda function.<br/><br/> If you set this to `tf`, then make sure you have the AWS CLI installed and<br/> configured with the necessary credentials on the machine where you run terraform. | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `"cfn"`    |    no    |

## Outputs

No outputs.

<!-- END_TF_DOCS -->
